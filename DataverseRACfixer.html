<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dataverse Support Tool (SPA)</title>
  <script src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js" integrity="sha384-q8YkymlfglZVhE5YzCmf3jv95nQKXtcwhkZy7hHxu8xj+qhu50bS6+Z9+MQUMk8F" crossorigin="anonymous"></script>
  <style>
    :root { --bg:#0b1020; --card:#121a35; --muted:#9fb0d1; --text:#e8f0ff; --accent:#4aa3ff; --danger:#ff5470; }
    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Arial; }
    body{ margin:0; background:linear-gradient(160deg,#0a0f22,#0e1630 55%,#0a1026); color:var(--text); }
    header{ padding:18px 22px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #1e2b56; position: sticky; top: 0; backdrop-filter: blur(6px); background:#0b1020cc; }
    header h1{ font-size:18px; margin:0; letter-spacing:.3px; }
    .container{ max-width:1100px; margin:24px auto; padding:0 16px 80px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width:900px){ .grid{ grid-template-columns: 2fr 3fr; } }
    .card{ background:var(--card); border:1px solid #1e2b56; border-radius:14px; padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    .card h2{ font-size:16px; margin:0 0 12px; color:#cfe1ff; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, button, textarea{ width:100%; border-radius:10px; border:1px solid #29407c; background:#0c1330; color:var(--text); padding:10px 12px; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--accent); box-shadow: 0 0 0 3px #4aa3ff33; }
    .row{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width:700px){ .row-2{ grid-template-columns: 1fr 1fr; } }
    .btn{ cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px; border-radius:10px; border:1px solid #2a4988; background:#10214d; color:#cfe1ff; }
    .btn:hover{ background:#0f1d45; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .btn.primary{ background:linear-gradient(180deg,#2266ff,#1649c9); border-color:#1649c9; }
    .btn.danger{ background:linear-gradient(180deg,#ff4d6d,#d73b56); border-color:#d73b56; }
    .status{ font-size:12px; color:var(--muted); margin-top:6px; }
    .kpi{ display:flex; gap:16px; flex-wrap:wrap; }
    .pill{ background:#0b1436; border:1px solid #26458b; border-radius:999px; padding:6px 10px; font-size:12px; color:#c9d8ff; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid #26356a; padding:8px 6px; font-size:12px; text-align:left; }
    pre{ margin:0; white-space:pre-wrap; word-break:break-word; }
    .hint{ font-size:11px; color:#a6b7dc; }
    .muted{ color:#9fb0d1; }
    .danger-text{ color:var(--danger); font-weight:600; }
    .ok{ color:#74ffa6; font-weight:600; }
    .footer{ font-size:11px; margin-top:16px; color:#9fb0d1; }
    .inline{ display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <header>
    <h1>Dataverse Support Tool · SPA (MSAL + Web API)</h1>
    <div class="kpi" style="margin-left:auto">
      <span class="pill" id="kpi-tenant">tenant: <strong>common</strong></span>
      <span class="pill" id="kpi-account">signed out</span>
      <span class="pill" id="kpi-scope">scope: –</span>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- AUTH / SETTINGS -->
      <section class="card">
        <h2>Auth & Org</h2>
        <div class="row">
          <div>
            <label>Client ID (SPA)</label>
            <input id="clientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
            <div class="hint">Your Entra app registration (platform: Single-page application). Stored locally.</div>
          </div>
          <div>
            <label>Tenant ID (or <code>common</code> for multi-tenant)</label>
            <input id="tenantId" placeholder="common or your-tenant-guid" />
          </div>
          <div>
            <label>Org base URL</label>
            <input id="orgUrl" placeholder="https://org12345.crm.dynamics.com" />
            <div class="hint">Used to compose the resource-specific scope <code>https://&lt;org&gt;.crm.dynamics.com/user_impersonation</code> and Web API calls.</div>
          </div>
        </div>
        <div class="row row-2" style="margin-top:12px">
          <button class="btn primary" id="btnInit">Initialize MSAL</button>
          <div class="inline">
            <button class="btn" id="btnLogin">Sign in</button>
            <button class="btn" id="btnLogout">Sign out</button>
          </div>
        </div>
        <div class="status" id="authStatus">MSAL not initialized.</div>
      </section>

      <!-- TOOL -->
      <section class="card">
        <h2>Dependency Check & Safe Delete</h2>
        <div class="row row-2" style="margin-top:4px">
          <div>
            <label>Dependency mode</label>
            <select id="depMode">
              <option value="forDelete">Blockers (for delete)</option>
              <option value="dependents">Dependents (used by)</option>
              <option value="both" selected>Both</option>
            </select>
          </div>
          <div class="status">Runs Web API functions: <code>RetrieveDependenciesForDelete</code> and/or <code>RetrieveDependentComponents</code>.</div>
        </div>
        <div class="row row-2">
          <div>
            <label>Object GUID</label>
            <input id="objectId" placeholder="e.g., 7437ad45-637e-f011-b4cc-000d3a3b163b" />
          </div>
          <div>
            <label>Component Type</label>
            <select id="componentType">
              <option value="1">1 — Table (EntityDefinition)</option>
              <option value="24">24 — Form (legacy)</option>
              <option value="26">26 — View (SavedQuery)</option>
              <option value="29">29 — Workflow/Process</option>
              <option value="31">31 — Report</option>
              <option value="60">60 — System Form</option>
              <option value="61">61 — Web Resource</option>
              <option value="90">90 — Plug-in Type</option>
              <option value="91">91 — Plug-in Assembly</option>
              <option value="92">92 — SDK Message Processing Step</option>
              <option value="93">93 — SDK Message Processing Step Image</option>
              <option value="300">300 — Canvas App</option>
              <option value="380">380 — Environment Variable Definition</option>
              <option value="381">381 — Environment Variable Value</option>
            </select>
          </div>
        </div>
        <div class="row row-2" style="margin-top:12px">
          <button class="btn" id="btnDeps">Retrieve dependencies</button>
          <button class="btn" id="btnFindRefs">Find references (heuristic)</button>
          <button class="btn danger" id="btnDelete" disabled>Delete component</button>
        </div>
        <div class="status" id="depsStatus">—</div>
        <div id="depsTableWrap" style="margin-top:10px; display:none">
          <h3 style="font-size:14px;margin:8px 0;color:#cfe1ff">Blockers (Prevent delete)</h3>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Dependent Type</th>
                <th>Dependent Object</th>
                <th>Required Type</th>
                <th>Required Object</th>
                <th>Relationship</th>
              </tr>
            </thead>
            <tbody id="depsBody"></tbody>
          </table>
        </div>
        <div id="deps2TableWrap" style="margin-top:10px; display:none">
          <h3 style="font-size:14px;margin:8px 0;color:#cfe1ff">Dependents (Used by)</h3>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Dependent Type</th>
                <th>Dependent Object</th>
                <th>Required Type</th>
                <th>Required Object</th>
                <th>Relationship</th>
              </tr>
            </thead>
            <tbody id="deps2Body"></tbody>
          </table>
        </div>
        <details style="margin-top:12px">
          <summary>Advanced · raw response</summary>
          <pre id="raw"></pre>
        </details>
        <div class="footer">Delete is enabled only when <span class="ok">no blocking dependencies</span> are found and after confirmation.</div>
      </section>

      <section class="card">
        <h2>Heuristic reference finder</h2>
        <div class="status" id="refStatus">—</div>
        <div id="refTables" style="margin-top:10px"></div>
      </section>

      <!-- CONFIRM -->
      <section class="card" style="grid-column: 1 / span 2">
        <h2>Danger zone</h2>
        <div class="row row-2">
          <div>
            <label>Type <span class="danger-text">DELETE</span> to enable deletion</label>
            <input id="confirmText" placeholder="DELETE" />
          </div>
          <div>
            <label>Dry‑run (skip real DELETE)</label>
            <select id="dryRun"><option value="true">true</option><option value="false">false</option></select>
          </div>
        </div>
        <div class="status" id="deleteStatus">—</div>
      </section>

    </div>

    <div class="footer">Tip: Use this in a clean browser profile. The app stores minimal settings in <code>localStorage</code> (clientId, tenantId, orgUrl).</div>
  </div>

<script>
(() => {
  // --- State ---
  let msalApp = null;
  let activeAccount = null;

  // --- Elements ---
  const el = (id) => document.getElementById(id);
  const $clientId = el('clientId');
  const $tenantId = el('tenantId');
  const $orgUrl = el('orgUrl');
  const $btnInit = el('btnInit');
  const $btnLogin = el('btnLogin');
  const $btnLogout = el('btnLogout');
  const $authStatus = el('authStatus');
  const $kpiTenant = el('kpi-tenant');
  const $kpiAccount = el('kpi-account');
  const $kpiScope = el('kpi-scope');

  const $objectId = el('objectId');
  const $componentType = el('componentType');
  const $btnDeps = el('btnDeps');
  const $btnDelete = el('btnDelete');
  const $depsStatus = el('depsStatus');
  const $depsTableWrap = el('depsTableWrap');
  const $depsBody = el('depsBody');
  const $raw = el('raw');
  const $depMode = el('depMode');
  const $deps2TableWrap = el('deps2TableWrap');
  const $deps2Body = el('deps2Body');
  const $btnFindRefs = el('btnFindRefs');
  const $refStatus = el('refStatus');
  const $refTables = el('refTables');

  const $confirmText = el('confirmText');
  const $dryRun = el('dryRun');
  const $deleteStatus = el('deleteStatus');

  let lastBlockersCount = null;

  // --- Utils ---
  const saveSettings = () => {
    localStorage.setItem('dv_clientId', $clientId.value.trim());
    localStorage.setItem('dv_tenantId', $tenantId.value.trim() || 'common');
    localStorage.setItem('dv_orgUrl', $orgUrl.value.trim());
  };
  const loadSettings = () => {
    $clientId.value = localStorage.getItem('dv_clientId') || '';
    $tenantId.value = localStorage.getItem('dv_tenantId') || 'common';
    $orgUrl.value = localStorage.getItem('dv_orgUrl') || '';
    $kpiTenant.innerHTML = `tenant: <strong>${$tenantId.value || 'common'}</strong>`;
  };
  const isGuid = (s) => /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test((s||'').trim());
  const validOrg = (u) => /^https:\/\/[^.]+\.crm(\d+)?\.dynamics\.com\/?$/i.test((u||'').trim());

  const componentTypeLabel = (n) => ({
    1:'Entity',24:'Form (legacy)',26:'SavedQuery (View)',29:'Workflow',31:'Report',60:'System Form',61:'Web Resource',90:'Plug-in Type',91:'Plug-in Assembly',92:'SDK Step',93:'SDK Step Image',300:'Canvas App',380:'Env Var Def',381:'Env Var Value'
  })[Number(n)] || String(n);

  function buildDeleteUrl(orgUrl, componentType, guid){
    const base = orgUrl.replace(/\/$/, '') + '/api/data/v9.2/';
    const ct = Number(componentType);
    switch(ct){
      case 1:   return base + `EntityDefinitions(${guid})`;
      case 24:  return base + `systemforms(${guid})`; // legacy
      case 26:  return base + `savedqueries(${guid})`;
      case 29:  return base + `workflows(${guid})`;
      case 31:  return base + `reports(${guid})`;
      case 60:  return base + `systemforms(${guid})`;
      case 61:  return base + `webresourceset(${guid})`;
      case 90:  return base + `plugintypes(${guid})`;
      case 91:  return base + `pluginassemblies(${guid})`;
      case 92:  return base + `sdkmessageprocessingsteps(${guid})`;
      case 93:  return base + `sdkmessageprocessingstepimages(${guid})`;
      case 300: return base + `canvasapps(${guid})`; // may require permissions in PP service
      case 380: return base + `environmentvariabledefinitions(${guid})`;
      case 381: return base + `environmentvariablevalues(${guid})`;
      default:  return null;
    }
  }

  function getScope(){
    const org = $orgUrl.value.trim();
    return org ? `${org.replace(/\/$/, '')}/user_impersonation` : null;
  }

  function msalConfig(){
    const tenant = ($tenantId.value.trim() || 'common');
    const redirectUri = window.location.origin + window.location.pathname;
    return {
      auth: {
        clientId: $clientId.value.trim(),
        authority: `https://login.microsoftonline.com/${tenant}`,
        redirectUri
      },
      cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: true }
    };
  }

  async function ensureMsal(){
    if (msalApp) return;
    const cfg = msalConfig();
    if(!cfg.auth.clientId) throw new Error('Client ID is required.');
    if(!validOrg($orgUrl.value)) throw new Error('Org base URL looks invalid.');
    msalApp = new msal.PublicClientApplication(cfg);
    await msalApp.initialize();
    const redirect = await msalApp.handleRedirectPromise().catch(console.warn);
    const accounts = msalApp.getAllAccounts();
    if (accounts.length) {
      activeAccount = accounts[0];
      msalApp.setActiveAccount(activeAccount);
    }
    $authStatus.textContent = 'MSAL ready.';
  }

  function setUiAuth(){
    $kpiTenant.innerHTML = `tenant: <strong>${$tenantId.value || 'common'}</strong>`;
    const scope = getScope();
    $kpiScope.textContent = 'scope: ' + (scope || '—');
    $kpiAccount.textContent = activeAccount ? `acct: ${activeAccount.username}` : 'signed out';
  }

  async function login(){
    await ensureMsal();
    const scope = getScope();
    const loginRequest = { scopes: [scope] };
    try {
      const result = await msalApp.loginPopup(loginRequest);
      activeAccount = result.account;
      msalApp.setActiveAccount(activeAccount);
      $authStatus.textContent = 'Signed in.';
    } catch(e){
      $authStatus.textContent = 'Sign-in failed: ' + (e.message || e);
      throw e;
    } finally {
      setUiAuth();
    }
  }

  async function logout(){
    if(!msalApp){ $authStatus.textContent = 'MSAL not initialized.'; return; }
    const acc = msalApp.getActiveAccount();
    if(!acc){ $authStatus.textContent = 'No active account.'; return; }
    await msalApp.logoutPopup({ account: acc });
    activeAccount = null;
    setUiAuth();
    $authStatus.textContent = 'Signed out.';
  }

  async function acquireToken(){
    await ensureMsal();
    const scope = getScope();
    const req = { scopes:[scope], account: activeAccount || msalApp.getActiveAccount() };
    try { return (await msalApp.acquireTokenSilent(req)).accessToken; }
    catch { return (await msalApp.acquireTokenPopup({ scopes:[scope] })).accessToken; }
  }

  function clearDepsTable(){
    $depsBody.innerHTML = '';
    $deps2Body.innerHTML = '';
    $depsTableWrap.style.display = 'none';
    $deps2TableWrap.style.display = 'none';
  }

  async function retrieveDependencies(){
    saveSettings();
    clearDepsTable();
    lastBlockersCount = null;
    $btnDelete.disabled = true;
    $deleteStatus.textContent = '—';

    const org = $orgUrl.value.trim().replace(/\/$/, '');
    const guid = $objectId.value.trim();
    const ct = Number($componentType.value);
    const mode = ($depMode && $depMode.value) || 'both';

    if(!validOrg(org)){ $depsStatus.textContent = 'Invalid org URL.'; return; }
    if(!isGuid(guid)){ $depsStatus.textContent = 'Invalid GUID.'; return; }

    const token = await acquireToken();

    const fmt = (d, name) => d[`${name}@OData.Community.Display.V1.FormattedValue`] || d[name] || '';
    const renderRows = (list, tbody) => {
      tbody.innerHTML = '';
      list.forEach((d, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${fmt(d,'dependentcomponenttype')}</td>
          <td><code>${fmt(d,'dependentcomponentobjectid')}</code></td>
          <td>${fmt(d,'requiredcomponenttype')}</td>
          <td><code>${fmt(d,'requiredcomponentobjectid')}</code></td>
          <td>${d.relationshipname || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    };

    const requests = [];
    if(mode === 'forDelete' || mode === 'both'){
      const url1 = `${org}/api/data/v9.2/RetrieveDependenciesForDelete(ObjectId=${guid},ComponentType=${ct})`;
      requests.push(fetch(url1, { headers:{ 'Authorization':`Bearer ${token}`,'Accept':'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0','Prefer':'odata.include-annotations="*"' } }).then(async r=>({ok:r.ok,json:await r.json().catch(()=>({})), kind:'forDelete'})));
    }
    if(mode === 'dependents' || mode === 'both'){
      const url2 = `${org}/api/data/v9.2/RetrieveDependentComponents(ObjectId=${guid},ComponentType=${ct})`;
      requests.push(fetch(url2, { headers:{ 'Authorization':`Bearer ${token}`,'Accept':'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0','Prefer':'odata.include-annotations="*"' } }).then(async r=>({ok:r.ok,json:await r.json().catch(()=>({})), kind:'dependents'})));
    }

    const results = await Promise.all(requests);

    let blockersMsg = '';
    let dependentsMsg = '';

    for(const res of results){
      if(!res.ok){
        const msg = (res.json && (res.json.error?.message)) || 'Request failed';
        if(res.kind === 'forDelete') blockersMsg = `Error getting blockers: ${msg}`;
        if(res.kind === 'dependents') dependentsMsg = `Error getting dependents: ${msg}`;
        continue;
      }
      const items = res.json.value || [];
      if(res.kind === 'forDelete'){
        lastBlockersCount = items.length;
        if(items.length){
          $depsStatus.innerHTML = `<span class="danger-text">${items.length} blocking dependencies found.</span>`;
          $depsTableWrap.style.display = '';
          renderRows(items, $depsBody);
        } else {
          $depsStatus.innerHTML = `<span class="ok">No blocking dependencies found for ${componentTypeLabel(ct)}.</span>`;
        }
      }
      if(res.kind === 'dependents'){
        if(items.length){
          dependentsMsg = `${items.length} dependents found.`;
          $deps2TableWrap.style.display = '';
          renderRows(items, $deps2Body);
        } else {
          dependentsMsg = `No dependents found.`;
        }
      }
      // keep last raw
      $raw.textContent = JSON.stringify(res.json, null, 2);
    }

    const statusBits = [];
    if(blockersMsg) statusBits.push(blockersMsg);
    if(dependentsMsg) statusBits.push(dependentsMsg);
    if(statusBits.length) $depsStatus.innerHTML += ` <span class="muted">(${statusBits.join(' · ')})</span>`;

    updateDeleteButtonState();
  }

  function updateDeleteButtonState(){
    const okConfirm = ($confirmText.value.trim() === 'DELETE');
    const noBlockers = (lastBlockersCount === 0);
    $btnDelete.disabled = !(okConfirm && noBlockers);
  }

  async function deleteComponent(){
    saveSettings();
    $deleteStatus.textContent = '';

    const org = $orgUrl.value.trim();
    const guid = $objectId.value.trim();
    const ct = Number($componentType.value);

    if($confirmText.value.trim() !== 'DELETE'){
      $deleteStatus.textContent = 'Type DELETE to confirm.'; return;
    }

    const delUrl = buildDeleteUrl(org, ct, guid);
    if(!delUrl){
      $deleteStatus.textContent = `Delete path not implemented for component type ${ct}.`;
      return;
    }

    if($dryRun.value === 'true'){
      $deleteStatus.textContent = `[dry‑run] Would DELETE ${delUrl}`;
      return;
    }

    const token = await acquireToken();

    const res = await fetch(delUrl, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json',
        'OData-MaxVersion':'4.0',
        'OData-Version':'4.0'
      }
    });

    if(res.status === 204){
      $deleteStatus.innerHTML = `<span class="ok">Deleted.</span>`;
    } else {
      let body = {};
      try{ body = await res.json(); }catch{}
      $deleteStatus.innerHTML = `<span class="danger-text">Delete failed:</span> ${(body.error && body.error.message) || res.statusText}`;
    }
  }

  // --- Heuristic Reference Search Helpers ---
  const odataEsc = (s) => (s||'').replace(/'/g, "''");
  function clearRefTables(){ $refTables.innerHTML = ''; }
  function renderTable(title, rows, cols){
    if(!rows || !rows.length) return;
    const card = document.createElement('div');
    card.innerHTML = `<h3 style="font-size:14px;margin:14px 0 6px;color:#cfe1ff">${title}</h3>`;
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = `<tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr>`;
    table.appendChild(thead);
    const tb = document.createElement('tbody');
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = cols.map(c=>`<td>${(r[c] ?? '')}</td>`).join('');
      tb.appendChild(tr);
    });
    table.appendChild(tb);
    card.appendChild(table);
    $refTables.appendChild(card);
  }

  async function apiGet(org, token, path){
    const url = `${org.replace(/\/$/,'')}/api/data/v9.2/${path}`;
    const res = await fetch(url, { headers:{
      'Authorization': `Bearer ${token}`,
      'Accept':'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0'
    }});
    const ok = res.ok; const json = await res.json().catch(()=>({}));
    if(!ok) throw new Error((json.error && json.error.message) || res.statusText);
    return json;
  }

  async function findReferences(){
    saveSettings();
    clearRefTables();
    $refStatus.textContent = 'Searching...';

    const org = $orgUrl.value.trim();
    const guid = $objectId.value.trim();
    const ct = Number($componentType.value);
    if(!validOrg(org)){ $refStatus.textContent = 'Invalid org URL.'; return; }
    if(!isGuid(guid)){ $refStatus.textContent = 'Invalid GUID.'; return; }

    const token = await acquireToken();

    // 0) Solutions that include this component
    const solRows = [];
    try{
      const sc = await apiGet(org, token, `solutioncomponents?$select=solutioncomponentid,solutionid&$filter=objectid eq ${guid} and componenttype eq ${ct}`);
      for(const row of (sc.value||[])){
        try{
          const sid = row.solutionid; if(!sid) continue;
          const sol = await apiGet(org, token, `solutions(${sid})?$select=friendlyname,uniquename`);
          solRows.push({ 'Solution name': sol.friendlyname || '(unnamed)', 'Unique name': sol.uniquename || '', 'Solution Id': sid });
        } catch{ /* ignore individual failures */ }
      }
      renderTable('Solutions containing the component', solRows, ['Solution name','Unique name','Solution Id']);
    }catch{ /* ignore if not accessible */ }

    // 1) Type-specific looks
    if(ct === 61){
      // Web Resource → search FormXml and SitemapXml by name
      try{
        const wr = await apiGet(org, token, `webresourceset(${guid})?$select=name,displayname`);
        const key = wr.name; if(key){
          const keyQ = odataEsc(key);
          const forms = await apiGet(org, token, `systemforms?$select=formid,name,objecttypecode,type&$filter=contains(formxml,'${keyQ}')&$top=250`);
          renderTable('Forms referencing web resource (by name match)', (forms.value||[]).map(f=>({ 'Form': f.name, 'Entity': f.objecttypecode, 'Type': f.type, 'Form Id': f.formid })), ['Form','Entity','Type','Form Id']);
          const sm = await apiGet(org, token, `sitemaps?$select=sitemapid,name&$filter=contains(sitemapxml,'${keyQ}')&$top=250`);
          renderTable('Sitemaps referencing web resource (by name match)', (sm.value||[]).map(s=>({ 'Sitemap': s.name, 'Sitemap Id': s.sitemapid })), ['Sitemap','Sitemap Id']);
        }
      }catch(e){ $refStatus.textContent = 'Search (web resource) error: ' + e.message; }
    }

    if(ct === 1){
      // Entity → forms, views, charts, sitemaps
      try{
        const ent = await apiGet(org, token, `EntityDefinitions(${guid})?$select=LogicalName,SchemaName,ObjectTypeCode`);
        const ln = ent.LogicalName; if(ln){
          const lnQ = odataEsc(ln);
          const forms = await apiGet(org, token, `systemforms?$select=formid,name,objecttypecode,type&$filter=objecttypecode eq '${lnQ}'`);
          renderTable('Forms of this entity', (forms.value||[]).map(f=>({ 'Form': f.name, 'Type': f.type, 'Form Id': f.formid })), ['Form','Type','Form Id']);
          const views = await apiGet(org, token, `savedqueries?$select=savedqueryid,name,returnedtypecode&$filter=returnedtypecode eq '${lnQ}'`);
          renderTable('System views of this entity', (views.value||[]).map(v=>({ 'View': v.name, 'View Id': v.savedqueryid })), ['View','View Id']);
          const ch1 = await apiGet(org, token, `savedqueryvisualizations?$select=savedqueryvisualizationid,name,primaryentitytypecode&$filter=primaryentitytypecode eq '${lnQ}'`);
          renderTable('Charts (system) of this entity', (ch1.value||[]).map(c=>({ 'Chart': c.name, 'Chart Id': c.savedqueryvisualizationid })), ['Chart','Chart Id']);
          const ch2 = await apiGet(org, token, `userqueryvisualizations?$select=userqueryvisualizationid,name,primaryentitytypecode&$filter=primaryentitytypecode eq '${lnQ}'`);
          renderTable('Charts (user) of this entity', (ch2.value||[]).map(c=>({ 'Chart': c.name, 'Chart Id': c.userqueryvisualizationid })), ['Chart','Chart Id']);
          const sm = await apiGet(org, token, `sitemaps?$select=sitemapid,name&$filter=contains(sitemapxml,'Entity=\"${lnQ}\"')`);
          renderTable('Sitemaps mentioning the entity', (sm.value||[]).map(s=>({ 'Sitemap': s.name, 'Sitemap Id': s.sitemapid })), ['Sitemap','Sitemap Id']);
        }
      }catch(e){ $refStatus.textContent = 'Search (entity) error: ' + e.message; }
    }

    if(ct === 91){
      // Plugin Assembly → Plug-in Types → Steps
      try{
        const pts = await apiGet(org, token, `plugintypes?$select=plugintypeid,name,typename&$filter=pluginassemblyid eq ${guid}`);
        renderTable('Plug-in types in this assembly', (pts.value||[]).map(p=>({ 'Type Name': p.typename || p.name, 'Type Id': p.plugintypeid })), ['Type Name','Type Id']);
        const stepRows = [];
        for(const p of (pts.value||[])){
          const steps = await apiGet(org, token, `sdkmessageprocessingsteps?$select=sdkmessageprocessingstepid,name&$filter=plugintypeid eq ${p.plugintypeid}`);
          (steps.value||[]).forEach(s=> stepRows.push({ 'Step': s.name, 'Step Id': s.sdkmessageprocessingstepid, 'Plug-in Type Id': p.plugintypeid }));
        }
        renderTable('Steps referencing those plug-in types', stepRows, ['Step','Step Id','Plug-in Type Id']);
      }catch(e){ $refStatus.textContent = 'Search (plugin assembly) error: ' + e.message; }
    }

    $refStatus.textContent = 'Heuristic search complete.';
  }

  // --- Wiring ---
  loadSettings();
  setUiAuth();

  $btnInit.addEventListener('click', async () => {
    try{ saveSettings(); await ensureMsal(); setUiAuth(); $authStatus.textContent = 'MSAL initialized.'; }
    catch(e){ $authStatus.textContent = 'Init failed: ' + (e.message || e); }
  });
  $btnLogin.addEventListener('click', async () => { try{ await login(); } catch{} });
  $btnLogout.addEventListener('click', async () => { try{ await logout(); } catch{} });
  $btnDeps.addEventListener('click', async () => { try{ await retrieveDependencies();
  $btnFindRefs.addEventListener('click', async () => { try{ await findReferences(); } catch(e){ $refStatus.textContent = 'Error: ' + (e.message || e); } }); } catch(e){ $depsStatus.textContent = 'Error: ' + (e.message || e); } });
  $btnDelete.addEventListener('click', async () => { try{ await deleteComponent(); } catch(e){ $deleteStatus.textContent = 'Error: ' + (e.message || e); } });

  $confirmText.addEventListener('input', () => { updateDeleteButtonState(); });
    // Only allow when no deps (message says so)
    if(/No blocking dependencies/.test($depsStatus.textContent)){
      $btnDelete.disabled = !enabled;
    }
  });

  [$clientId, $tenantId, $orgUrl].forEach(x => x.addEventListener('change', () => { saveSettings(); setUiAuth(); }));
})();
</script>
</body>
</html>
